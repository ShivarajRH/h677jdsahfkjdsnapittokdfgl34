<?php 
	$user=$this->erpm->auth(PURCHASE_ORDER_ROLE);
	$no_days = date_diff_days(date('Y-m-d'),$po['date_of_delivery']);
	$is_po_exp = 0;
	if($no_days < 0)
	{
		$poid=$po['po_id'];
		$remarks='By System';
		if($this->db->query("select * from t_po_info where po_status!=3 and po_id=?",$poid)->num_rows()!=0)
			$this->db->query("update t_po_info set po_status=3,status_remarks=?,modified_on=now(),modified_by=? where po_id=? limit 1",array($remarks,$user['userid'],$poid));
		$is_po_exp = 1;
	}
	?>
<?php $po_status_arr=array();
$po_status_arr[0]="Open";
$po_status_arr[1]="Partially Received";
$po_status_arr[2]="Complete";
$po_status_arr[3]="Cancelled";?>
<div class="container">
	<span class="fl_right">
		<?php if($po['po_status']!="2" && $po['po_status']!="3"){?>
			<a onclick='closepo( )' href="javascript:void(0)" class="button button-tiny button-caution button-rounded" >Close PO</a>
		<?php } ?>
		<a class="button button-tiny" onclick="print_po(<?=$po['po_id']?>)" >Print po</a>
	</span>
	<h2>Purchase Order : <?=$po['po_id']?></h2>

<fieldset style=" width: 70%;">
<legend><b>PO Details</b></legend>
<table>
<tr>
<td width="45%">
<div width="50%">
<table cellspacing="5" width="100%">
<tbody>
<tr><td><b>Supplier</b></td><td>|</td><td><a target="_blank" href="<?php echo site_url("/admin/vendor/{$po['vendor_id']}")?>"><?=$po['vendor_name'] ?></a></td></tr>
<tr><td><b>Purchase Order</b></td><td>|</td><td><?=$po['po_id'] ?></td></tr>
<tr><td><b>Created Date</b></td><td>|</td><td><?=format_date($po['created_on'] )?></td></tr>
<?php if($po['date_of_delivery'] && $po['remarks']){?>
<tr><td><b>Scheduled Date</b></td><td>|</td><td><?=format_date($po['date_of_delivery'] )?></td></tr>
<tr><td><b>Remarks</b></td><td>|</td><td><?=$po['remarks'] ?></td></tr>
<?php }?>
<tr><td><b>Created By</b></td><td>|</td><td><?=$po['created_byname'] ?></td></tr>
<?php if(!$po['date_of_delivery'] || !$po['remarks']){?>
<tr><td><input onclick='update_po_det(<?php echo $po['po_id'] ?>)' class="update_link button-rounded button button-flat-caution button-small" value="Update Remarks"></td></tr>
<?php }?>
</div>
</tbody>
</table>
</div></td>
<td width="45%">
<div width="50%" style="float:right;margin-left:117px;">
<table cellspacing="5" width="100%">
<tbody>
<tr><td><b>Po value</b></td><td>|</td><td>Rs <?=format_price($ttl_po_val)?></td></tr>
<tr><td><b>Status</b></td><td>|</td>
<td>
<?if($po['po_status']==0){?>
<span style="color: orange"><b><?php echo $po_status_arr[$po['po_status']]?></b></span>

<?php }if($po['po_status']==3){?>
<span style="color: red"><b><?php echo $po_status_arr[$po['po_status']] ?></b></span>
<?php }?>
</td></tr>
<?php if($po['modified_on']!=null){?>
<tr><td><b>Updated on</b></td><td>|</td><td><?=format_date($po['modified_on']) ?></td></tr>
<tr><td><b>Status Remarks</b></td><td>|</td><td><?=$po['status_remarks']?></td></tr>
<tr><td><b>Updated by</b></td><td>|</td><td><?=$po['modified_byname'] ?></td></tr>
<?php }?>
</tbody>
</table>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</fieldset>

<div class="tab_view">
<ul>
<li><a href="#po_list"><b>Product List</b></a></li>
<li><a href="#po_removedlist"><b>Removed Product List</b></a></li>
</ul>
<div id="po_list">
<table class="datagrid" width="100%">
<thead>
<th>Slno</th>
<th>Product Name</th>
<th>Order Qty</th>
<th>Received Qty</th>
<th>MRP</th>
<th>DP Price</th>
<th>Margin</th>
<th>Scheme Discount</th>
<th style="text-align:right;">Unit Price</th>
<th style="text-align:right;">Sub Total</th>
<th style="text-align:right;">Action</th>
</thead>
<tbody>
<?php $sno=1; foreach($items as $i){
	
?>
<tr>
<td><?=$sno++?></td>
<td><a href="<?=site_url("admin/product/{$i['product_id']}")?>"><?=$i['product_name']?></a></td>
<td><?=$i['order_qty']?></td>
<td><?=$i['received_qty']?></td>
<td><?=$i['mrp']?></td>
<td><?=$i['dp_price']?></td>
<td><?=$i['margin']?>%</td>
<td><?=$i['scheme_discount_value']?$i['scheme_discount_value']:0?>%</td>
<td style="text-align:right;"><?=format_price($i['purchase_price'])?></td>
<td style="text-align:right;"><?=format_price($i['purchase_price']*$i['order_qty'])?></td>
<td style="text-align:right;"><a href="javascript:void(0)" onclick="remove_prod_frmpo(<?php echo $i['product_id']?>)" prodid=<?php echo $i['product_id'];?> ><img  src="<?php echo base_url().'images/icon_delete13.gif'?>"></a></td>
</tr>
<?php }?>
</tbody>
</table>
<br>
<div style="float:right;margin-right: 65px;margin-top:-11px;">
<b>Total Purchase Value:Rs&nbsp;&nbsp;<?=format_price($ttl_po_val)?></b>
</div>

</div>

<div id="po_removedlist">
<table class="datagrid" width="100%">
<thead>
<th>Slno</th>
<th>Product Name</th>
<th>Order Qty</th>
<th>Received Qty</th>
<th>MRP</th>
<th>DP Price</th>
<th>Margin</th>
<th>Scheme Discount</th>
<th>Unit Price</th>
<th>Sub Total</th>
<th>Removed By</th>
<th>Removed on</th>
</thead>
<tbody>
<?php $sno=1;if($removed_poprod_list){foreach($removed_poprod_list as $r_po){?>
<tr>
<td><?=$sno++?></td>
<td><a href="<?=site_url("admin/product/{$r_po['product_id']}")?>"><?=$r_po['product_name']?></a></td>
<td><?=$r_po['order_qty']?></td>
<td><?=$r_po['received_qty']?></td>
<td><?=$r_po['mrp']?></td>
<td><?=$r_po['dp_price']?></td>
<td><?=$r_po['margin']?>%</td>
<td><?=$r_po['scheme_discount_value']?$i['scheme_discount_value']:0?>%</td>
<td><?=format_price($r_po['purchase_price'])?></td>
<td><?=format_price($r_po['purchase_price']*$r_po['order_qty'])?></td>
<td><?=$r_po['modifiedby'] ?></td>
<td><?=format_datetime($r_po['modified_on'])?></td>
</tr>
<?php }} else{ echo "<tr><td><div align='center'><b>No Data Found</b></div></td></tr>";}?>

</tbody>

</table>

</div>

</div>

<div id="status_rmrks_div" title="Reason for Closing Purchase order">
<form action="<?php echo site_url("admin/closepo/{$po['po_id']}")?>" method="post" data-validate="parsley" id="remrks_update_frm">
	<textarea name="status_remarks"  style="width: 100%;height: 100px;" data-required="true"></textarea>
</form>
</div>

<div id="update_po_delivery_det" title="update Expected delivery details" style="display:none;">
<form method="post" action="<?php echo site_url('admin/updatedeliverydate/'.$po['po_id'])?>" id="delivery_det_frm"  data-validate="parsley" >
<table>
<tr><td>Expected Delivery Date</td><td><input type="text" name="po_deliverydate" id="po_deliverydate" value="" data-required="true"></td></tr>
<tr><td>Remarks</td><td><textarea name="po_remarks" value="" data-required="true"></textarea></td></tr>
</table>
</form>
</div>

<script>
$('.leftcont').hide();
$('.tab_view').tabs();
function update_po_det(po_id)
{
	$('#update_po_delivery_det').data('po_id',po_id).dialog('open');
}
$('#update_po_delivery_det').dialog({
	modal:true,
	autoOpen:false,
	autoResize:true,
	width:'400',
	height:'auto',
	open:function(){
		
	},
	buttons:{
		'Cancel' :function(){
		 $(this).dialog('close');
		},
		'Submit':function(){
			var dlg= $(this);
			var frm_podetails = $("#delivery_det_frm",this);
				 if(frm_podetails.parsley('validate')){
						frm_podetails.submit();
					 $("#delivery_det_frm").dialog('close');
				}
	            else
	            {
	            	alert('All Fields are required!!!');
	            }
		},
	}
});
$("#po_deliverydate").datepicker({ minDate: 0 });
	
function closepo()
{
	/*if(confirm("Are you sure?"))
		location="<?//=site_url("admin/closepo/{$po['po_id']}")?>";*/
	$("#status_rmrks_div").dialog('open');
}
$("#status_rmrks_div").dialog({
modal:true,
autoOpen:false,
width:400,
height:'auto',
open:function(){
},
buttons:{
	'Cancel':function(){
		$(this).dialog('close');
	},
	'Submit':function(){
		var dlg= $(this);
		var status_rmrks_frm = $("#remrks_update_frm",this);
			 if(status_rmrks_frm.parsley('validate')){
				 status_rmrks_frm.submit();
				 $("#status_rmrks_div").dialog('close');
			}
            else
            {
            	alert('All Fields are required!!!');
            }
	},
	
}
});

function updateexpected_podeliverydate()
{
	if(confirm("Are you sure ?"))
		location="<?=site_url("admin/updatedeliverydate/{$po['po_id']}")?>";
}

function print_po(poid)
{
	var print_url = site_url+'/admin/print_po/'+poid;
		window.open(print_url);
}

function remove_prod_frmpo(pid)
{
	var prodid=pid;
	if(confirm("Are you sure  want to remove this product from PO?"))
		location="<?=site_url('admin/remove_prodfrmpo/'.$po['po_id'])?>/"+prodid;
}
</script>
 
